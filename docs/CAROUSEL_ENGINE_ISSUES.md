# Carousel Engine ‚Äî –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ –ø–ª–∞–Ω –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

**–î–∞—Ç–∞:** 2026-02-11
**–§–∞–π–ª Edge Function:** `supabase/functions/carousel-engine/index.ts`
**–î–µ–ø–ª–æ–π:** `supabase functions deploy carousel-engine --project-ref debcwvxlvozjlqkhnauy`

---

## –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

Carousel-engine ‚Äî Supabase Edge Function, –∫–æ—Ç–æ—Ä–∞—è –∑–∞–º–µ–Ω—è–µ—Ç —Å—Ç–∞—Ä—ã–π n8n workflow (`carousel-v2`).
–°–µ–π—á–∞—Å **—Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—ã** (–ø–æ `isAdmin()`) –º–∞—Ä—à—Ä—É—Ç–∏–∑–∏—Ä—É—é—Ç—Å—è –Ω–∞ carousel-engine, –æ–±—ã—á–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ ‚Äî –Ω–∞ n8n.
–ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –≤: `src/pages/agents/carousel/content.tsx` –∏ `src/pages/agents/carousel/index.tsx`.

### –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ–∫—Å—Ç–∞ (–∫–æ–ø–∏—Ä–∞–π—Ç–∏–Ω–≥) —á–µ—Ä–µ–∑ Gemini 2.5 Flash (Vertex AI)
- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —á–µ—Ä–µ–∑ Gemini 3 (AI Studio API)
- –ü–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ñ–æ—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫–∞–∫ reference image –¥–ª—è FACE-—Å–ª–∞–π–¥–æ–≤
- –û—Ç–ø—Ä–∞–≤–∫–∞ —Å—Ç–∞—Ç—É—Å–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤ Telegram
- –û—Ç–ø—Ä–∞–≤–∫–∞ –≥–æ—Ç–æ–≤–æ–π –∫–∞—Ä—É—Å–µ–ª–∏ –≤ Telegram

### –ß—Ç–æ –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç / –ø—Ä–æ–±–ª–µ–º—ã:

---

## –ü–†–û–ë–õ–ï–ú–ê 1: –ù–µ—Ç —Ç–∞–π–º-–∞—É—Ç–æ–≤ –Ω–∞ API-–≤—ã–∑–æ–≤—ã ‚Äî –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≤–∏—Å–∞–µ—Ç –Ω–∞–≤—Å–µ–≥–¥–∞

**–°–∏–º–ø—Ç–æ–º:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª "–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å", –ø—Ä–∏—à–ª–æ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ "–ö–∞—Ä—É—Å–µ–ª—å –∑–∞–ø—É—â–µ–Ω–∞", –∏ –≤—Å—ë ‚Äî –¥–∞–ª—å—à–µ —Ç–∏—à–∏–Ω–∞. –í –ª–æ–≥–∞—Ö —Å—Ç–∞—Ç—É—Å `generating_text` –≤–∏—Å–∏—Ç –±–µ–∑ –æ—à–∏–±–∫–∏.

**–ü—Ä–∏—á–∏–Ω–∞:** –§—É–Ω–∫—Ü–∏–∏ `generateTextGemini()` –∏ `generateTextOpenRouter()` –≤—ã–∑—ã–≤–∞—é—Ç `fetch()` **–ë–ï–ó —Ç–∞–π–º-–∞—É—Ç–∞**. –ï—Å–ª–∏ Gemini API –ø–æ–≤–∏—Å (rate limit, —Å–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞, 504), fetch –∂–¥—ë—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ, –ø–æ–∫–∞ Supabase –Ω–µ —É–±—å—ë—Ç Edge Function –ø–æ –æ–±—â–µ–º—É –ª–∏–º–∏—Ç—É (150 —Å–µ–∫—É–Ω–¥ –¥–ª—è `waitUntil`).

**–ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:**
- `generateTextGemini()` ‚Äî —Å—Ç—Ä–æ–∫–∞ ~262 ‚Äî `fetch(endpoint, ...)` –±–µ–∑ signal/timeout
- `generateTextOpenRouter()` ‚Äî —Å—Ç—Ä–æ–∫–∞ ~287 ‚Äî `fetch(...)` –±–µ–∑ signal/timeout
- `generateImageGemini()` ‚Äî —Å—Ç—Ä–æ–∫–∞ ~498 ‚Äî `fetch(endpoint, ...)` –±–µ–∑ signal/timeout
- `generateImageImagen()` ‚Äî —Å—Ç—Ä–æ–∫–∞ ~363 ‚Äî `fetch(endpoint, ...)` –±–µ–∑ signal/timeout
- `generateImageIdeogram()` ‚Äî —Å—Ç—Ä–æ–∫–∞ ~405 ‚Äî `fetch(...)` –±–µ–∑ signal/timeout

**–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:**

```typescript
// –î–æ–±–∞–≤–∏—Ç—å —Ö–µ–ª–ø–µ—Ä fetchWithTimeout:
async function fetchWithTimeout(url: string, options: RequestInit, timeoutMs = 60000): Promise<Response> {
    const controller = new AbortController()
    const timeout = setTimeout(() => controller.abort(), timeoutMs)
    try {
        const response = await fetch(url, { ...options, signal: controller.signal })
        return response
    } finally {
        clearTimeout(timeout)
    }
}

// –ó–∞–º–µ–Ω–∏—Ç—å –≤—Å–µ fetch() –≤ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–∞ fetchWithTimeout():
// - –¢–µ–∫—Å—Ç: 60 —Å–µ–∫—É–Ω–¥ —Ç–∞–π–º-–∞—É—Ç
// - –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: 90 —Å–µ–∫—É–Ω–¥ —Ç–∞–π–º-–∞—É—Ç (–æ–Ω–∏ –¥–æ–ª—å—à–µ)
```

–¢–∞–∫–∂–µ: –µ—Å–ª–∏ `generateText()` –±—Ä–æ—Å–∞–µ—Ç –æ—à–∏–±–∫—É ‚Äî –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –ª–æ–≥ –≤ –ë–î –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤ Telegram. –°–µ–π—á–∞—Å –æ—à–∏–±–∫–∞ –∏–∑ `generateText()` –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≤ `runPipeline() catch`, –Ω–æ –∫ —ç—Ç–æ–º—É –º–æ–º–µ–Ω—Ç—É —Ñ—É–Ω–∫—Ü–∏—è –º–æ–∂–µ—Ç —É–∂–µ –±—ã—Ç—å —É–±–∏—Ç–∞ Supabase.

---

## –ü–†–û–ë–õ–ï–ú–ê 2: –ù–µ—Ç –≤–æ–∑–≤—Ä–∞—Ç–∞ –º–æ–Ω–µ—Ç –ø—Ä–∏ –æ—à–∏–±–∫–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏

**–°–∏–º–ø—Ç–æ–º:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ—Ç—Ä–∞—Ç–∏–ª –º–æ–Ω–µ—Ç—ã ‚Üí –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≤–∏—Å–ª–∞/—É–ø–∞–ª–∞ ‚Üí –º–æ–Ω–µ—Ç—ã –Ω–µ –≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã.

**–ü—Ä–∏—á–∏–Ω–∞:** Carousel-engine **–Ω–µ –∑–Ω–∞–µ—Ç** –æ –º–æ–Ω–µ—Ç–∞—Ö. –°–ø–∏—Å–∞–Ω–∏–µ –º–æ–Ω–µ—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–µ (`spendCoinsForGeneration()`), –∞ refund –¥–æ–ª–∂–µ–Ω –≤—ã–∑—ã–≤–∞—Ç—å—Å—è –ø—Ä–∏ –æ—à–∏–±–∫–µ. –ï—Å—Ç—å Edge Function `refund-carousel-coins`, –Ω–æ carousel-engine –µ—ë –Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç.

**–ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ —Ñ–∞–π–ª—ã:**
- `supabase/functions/carousel-engine/index.ts` ‚Äî `runPipeline()` catch-–±–ª–æ–∫, —Å—Ç—Ä–æ–∫–∞ ~1160
- `supabase/functions/refund-carousel-coins/index.ts` ‚Äî —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç

**–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:**

–í `runPipeline()` catch-–±–ª–æ–∫ –¥–æ–±–∞–≤–∏—Ç—å –≤—ã–∑–æ–≤ refund:
```typescript
catch (err) {
    // ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ ...

    // –í–æ–∑–≤—Ä–∞—Ç –º–æ–Ω–µ—Ç –ø—Ä–∏ –æ—à–∏–±–∫–µ
    try {
        const supabase = getSupabaseClient()
        await supabase.rpc('add_coins', {
            p_user_id: payload.chatId,  // telegram_id
            p_amount: GENERATION_COST,  // –Ω—É–∂–Ω–æ –∑–Ω–∞—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å
            p_reason: 'refund_carousel_error'
        })
        console.log('[Engine] Coins refunded for user', payload.chatId)
    } catch (refundErr) {
        console.error('[Engine] Failed to refund coins:', refundErr)
    }
}
```

–ü—Ä–æ–±–ª–µ–º–∞: carousel-engine –Ω–µ –∑–Ω–∞–µ—Ç —Å–∫–æ–ª—å–∫–æ –º–æ–Ω–µ—Ç –±—ã–ª–æ —Å–ø–∏—Å–∞–Ω–æ. –í–∞—Ä–∏–∞–Ω—Ç—ã:
1. –ü–µ—Ä–µ–¥–∞–≤–∞—Ç—å `coinsSpent` –≤ payload —Å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
2. –•–∞—Ä–¥–∫–æ–¥–∏—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å (—Å–µ–π—á–∞—Å 1 –º–æ–Ω–µ—Ç–∞)
3. –í—ã–∑—ã–≤–∞—Ç—å RPC `refund-carousel-coins`

---

## –ü–†–û–ë–õ–ï–ú–ê 3: –ù–µ—Ç fallback –Ω–∞ OpenRouter –ø—Ä–∏ –æ—à–∏–±–∫–µ Gemini

**–°–∏–º–ø—Ç–æ–º:** –ï—Å–ª–∏ Gemini API —É–ø–∞–ª (429 rate limit, 503, timeout), –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–∞–¥–∞–µ—Ç. –ù–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –Ω–∞ OpenRouter.

**–ü—Ä–∏—á–∏–Ω–∞:** –í `generateText()` –µ—Å—Ç—å fallback-–ª–æ–≥–∏–∫–∞, –Ω–æ:
1. Fallback –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `config.text_model` (primary model, –Ω–∞–ø—Ä–∏–º–µ—Ä `gemini-2.5-flash`) –¥–∞–∂–µ –¥–ª—è OpenRouter, –≥–¥–µ –Ω—É–∂–Ω–∞ –¥—Ä—É–≥–∞—è –º–æ–¥–µ–ª—å
2. –ù–µ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ `text_fallback_model` ‚Äî –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É –≤ –ë–î
3. –ù–µ—Ç —Ä–æ—Ç–∞—Ü–∏–∏ API –∫–ª—é—á–µ–π –ø—Ä–∏ 429

**–ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–π –∫–æ–¥:**
- `generateText()` —Å—Ç—Ä–æ–∫–∞ ~315 ‚Äî fallback –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `config.text_model` –≤–º–µ—Å—Ç–æ `config.text_fallback_model`

**–ë–∞–≥ –≤ —Ç–µ–∫—É—â–µ–º –∫–æ–¥–µ (—Å—Ç—Ä–æ–∫–∞ 333):**
```typescript
// –°–ï–ô–ß–ê–° (–±–∞–≥): –∏—Å–ø–æ–ª—å–∑—É–µ—Ç primary model –¥–ª—è fallback
return await generateTextOpenRouter(systemPrompt, userPrompt, config.text_model, config.text_fallback_key)

// –ü–†–ê–í–ò–õ–¨–ù–û: –¥–æ–ª–∂–µ–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å fallback model
return await generateTextOpenRouter(systemPrompt, userPrompt, config.text_fallback_model || 'google/gemini-2.5-flash', config.text_fallback_key)
```

**–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:**
1. –î–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É `text_fallback_model` –≤ `ai_engine_config` (–º–∏–≥—Ä–∞—Ü–∏—è –ë–î)
2. –û–±–Ω–æ–≤–∏—Ç—å `EngineConfig` interface
3. –ò—Å–ø—Ä–∞–≤–∏—Ç—å `generateText()` ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `text_fallback_model`
4. –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π: `image_fallback_provider`, `image_fallback_model`, `image_fallback_api_key`

---

## –ü–†–û–ë–õ–ï–ú–ê 4: –ù–µ—Ç fallback –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

**–°–∏–º–ø—Ç–æ–º:** –ï—Å–ª–∏ Gemini 3 Image API —É–ø–∞–ª, —Å–ª–∞–π–¥ –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è (null). –ï—Å–ª–∏ –í–°–ï —Å–ª–∞–π–¥—ã —É–ø–∞–ª–∏ ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∏—Ç –ø—É—Å—Ç–æ–π –∞–ª—å–±–æ–º –∏–ª–∏ –æ—à–∏–±–∫—É.

**–ü—Ä–∏—á–∏–Ω–∞:** `generateImage()` –Ω–µ –∏–º–µ–µ—Ç fallback. –ï—Å–ª–∏ primary image provider (gemini) —É–ø–∞–ª, –Ω–µ—Ç –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –Ω–∞ Imagen –∏–ª–∏ Ideogram.

**–ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–π –∫–æ–¥:**
- `generateImage()` —Å—Ç—Ä–æ–∫–∞ ~546 ‚Äî –Ω–µ—Ç try/catch —Å fallback
- –ö–∞–∂–¥—ã–π —Å–ª–∞–π–¥ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è —Å `.catch(() => null)` ‚Äî –º–æ–ª—á–∞ –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç—Å—è

**–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:**
```typescript
async function generateImage(prompt, config, referenceImageBase64?) {
    try {
        // Primary provider
        return await generateImageByProvider(prompt, config.image_provider, config.image_model, config.image_api_key, referenceImageBase64)
    } catch (err) {
        // Fallback provider
        if (config.image_fallback_provider) {
            return await generateImageByProvider(prompt, config.image_fallback_provider, config.image_fallback_model, config.image_fallback_api_key, referenceImageBase64)
        }
        throw err
    }
}
```

---

## –ü–†–û–ë–õ–ï–ú–ê 5: –°—Ç–∞—Ç—É—Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –≤ –ë–î –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–≤–∏—Å–∞–Ω–∏–∏

**–°–∏–º–ø—Ç–æ–º:** –í –∞–¥–º–∏–Ω–∫–µ –ª–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç `generating_text` –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ. –ù–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º–∞ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å "–∑–∞–≤–∏—Å—à–∏–µ" –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏.

**–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:**
1. –î–æ–±–∞–≤–∏—Ç—å —Ç–∞–π–º-–∞—É—Ç—ã (–ø—Ä–æ–±–ª–µ–º–∞ 1) ‚Äî —Ç–æ–≥–¥–∞ —Å—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–∏—Ç—Å—è –≤ catch
2. –î–æ–±–∞–≤–∏—Ç—å cron/check: –µ—Å–ª–∏ —Å—Ç–∞—Ç—É—Å `generating_text` –∏–ª–∏ `generating_images` > 5 –º–∏–Ω—É—Ç ‚Äî –ø–æ–º–µ—á–∞—Ç—å –∫–∞–∫ `timeout` –∏ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –º–æ–Ω–µ—Ç—ã
3. –í `runPipeline()` –ø–µ—Ä–µ–¥ –∫–∞–∂–¥—ã–º —à–∞–≥–æ–º –ø—Ä–æ–≤–µ—Ä—è—Ç—å `Date.now() - startTime > MAX_PIPELINE_MS` –∏ –ø—Ä–µ—Ä—ã–≤–∞—Ç—å

---

## –ü–†–û–ë–õ–ï–ú–ê 6: –ö–æ–¥–æ–≤–æ–µ —Å–ª–æ–≤–æ –Ω–µ –≤—Å–µ–≥–¥–∞ –ø–æ–ø–∞–¥–∞–µ—Ç –Ω–∞ CTA-—Å–ª–∞–π–¥

**–°–∏–º–ø—Ç–æ–º:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤—ë–ª –∫–æ–¥–æ–≤–æ–µ —Å–ª–æ–≤–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä "–ú–ê–ì–ò–Ø"), –Ω–æ –Ω–∞ —Å–ª–∞–π–¥–µ 8 (CTA) –µ–≥–æ –Ω–µ—Ç.

**–ü—Ä–∏—á–∏–Ω–∞:** AI –º–æ–¥–µ–ª—å (Gemini) –Ω–µ –≤—Å–µ–≥–¥–∞ —Å–ª–µ–¥—É–µ—Ç –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º –≤ –ø—Ä–æ–º–ø—Ç–µ. –ü—Ä–æ–º–ø—Ç —É—Å–∏–ª–µ–Ω (–¥–æ–±–∞–≤–ª–µ–Ω—ã —è–≤–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏), –Ω–æ AI –Ω–µ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ.

**–ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ:**
- –í fallback –ø—Ä–æ–º–ø—Ç–µ —Å–ª–∞–π–¥ 8 —Ç–µ–ø–µ—Ä—å: `"headline": "–ü–ò–®–ò: {CTA_CODE}"`
- –î–æ–±–∞–≤–ª–µ–Ω–æ –ø—Ä–∞–≤–∏–ª–æ: ¬´headline –î–û–õ–ñ–ï–ù —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∫–æ–¥–æ–≤–æ–µ —Å–ª–æ–≤–æ¬ª
- –í userPrompt: ¬´–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –Ω–∞ —Å–ª–∞–π–¥–µ 8 –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å "{CTA_CODE}"¬ª
- –í `buildImagePrompt()` –¥–ª—è CTA-—Å–ª–∞–π–¥–∞: –¥–æ–ø. –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å –∫–æ–¥–æ–≤–æ–µ —Å–ª–æ–≤–æ

**–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –º–æ–∂–Ω–æ:**
- –ü–æ—Å–ª–µ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON –æ—Ç AI ‚Äî **–ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å** —á—Ç–æ slide[7] (CTA) —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–æ–¥–æ–≤–æ–µ —Å–ª–æ–≤–æ –≤ headline. –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ.

---

## –ê–†–•–ò–¢–ï–ö–¢–£–†–ê: –û—Ç–∫—É–¥–∞ –±–µ—Ä—É—Ç—Å—è –ø—Ä–æ–º–ø—Ç—ã

### –ü—Ä–æ–º–ø—Ç –¥–ª—è –∫–æ–ø–∏—Ä–∞–π—Ç–∏–Ω–≥–∞ (—Ç–µ–∫—Å—Ç —Å–ª–∞–π–¥–æ–≤)

**–§—É–Ω–∫—Ü–∏—è:** `buildCopywriterPrompt(payload)` –≤ `carousel-engine/index.ts`

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–∫—Ç–æ –ø–æ–±–µ–∂–¥–∞–µ—Ç):**
1. `payload.styleConfig.content_system_prompt` ‚Äî –ø—Ä–æ–º–ø—Ç –∏–∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å—Ç–∏–ª—è –∫–∞—Ä—É—Å–µ–ª–∏. –•—Ä–∞–Ω–∏—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü–µ `carousel_styles`, –∫–æ–ª–æ–Ω–∫–∞ `config.content_system_prompt`. –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω–∫—É "–°—Ç–∏–ª–∏ –∫–∞—Ä—É—Å–µ–ª–µ–π".
2. `payload.globalSystemPrompt` ‚Äî –≥–ª–æ–±–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç. –•—Ä–∞–Ω–∏—Ç—Å—è –≤ `ai_engine_config.global_system_prompt`. –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω–∫—É "AI Engine". –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —Ñ—É–Ω–∫—Ü–∏–µ–π `getGlobalSystemPrompt()` –∏–∑ `src/lib/carouselStylesApi.ts`.
3. **Fallback —Ö–∞—Ä–¥–∫–æ–¥** ‚Äî –∑–∞—à–∏—Ç –ø—Ä—è–º–æ –≤ `buildCopywriterPrompt()`, —Å—Ç—Ä–æ–∫–∏ ~790-854. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –µ—Å–ª–∏ –ø–µ—Ä–≤—ã–µ –¥–≤–∞ –ø—É—Å—Ç—ã –∏–ª–∏ –∫–æ—Ä–æ—á–µ 20 —Å–∏–º–≤–æ–ª–æ–≤.

### –ü—Ä–æ–º–ø—Ç –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (–¥–∏–∑–∞–π–Ω —Å–ª–∞–π–¥–æ–≤)

**–§—É–Ω–∫—Ü–∏—è:** `buildImagePrompt(slide, stylePrompt, payload, hasReferencePhoto)` –≤ `carousel-engine/index.ts`

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:**
1. `payload.styleConfig.slide_templates[slideType]` ‚Äî —à–∞–±–ª–æ–Ω—ã –∏–∑ —Å—Ç–∏–ª—è. –ù–∞–ø—Ä–∏–º–µ—Ä –¥–ª—è HOOK, CONTENT, CTA, VIRAL. –° –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–∞–º–∏ `{HEADLINE}`, `[POSE]`, `[PRODUCT_CODE]` –∏ —Ç.–¥.
2. **Fallback —Ö–∞—Ä–¥–∫–æ–¥** ‚Äî –µ—Å–ª–∏ –Ω–µ—Ç —à–∞–±–ª–æ–Ω–∞, —Å—Ç—Ä–æ–∏—Ç—Å—è –±–∞–∑–æ–≤—ã–π –ø—Ä–æ–º–ø—Ç. –î–ª—è FACE-—Å–ª–∞–π–¥–æ–≤ (HOOK/CTA) ‚Äî —Å –ø–µ—Ä—Å–æ–Ω–æ–π, –ø–æ–∑–æ–π, —ç–º–æ—Ü–∏–µ–π. –î–ª—è CONTENT ‚Äî –±–µ–∑ –ø–µ—Ä—Å–æ–Ω—ã, –∏–Ω—Ñ–æ–≥—Ä–∞—Ñ–∏–∫–∞. –î–ª—è VIRAL ‚Äî –∏–∫–æ–Ω–∫–∏ —à–∞—Ä–∏–Ω–≥–∞.

### –ü—Ä–æ–º–ø—Ç –¥–ª—è Instagram caption (post_text)

–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è AI –≤ —Å–æ—Å—Ç–∞–≤–µ JSON –æ—Ç–≤–µ—Ç–∞ –∫–æ–ø–∏—Ä–∞–π—Ç–µ—Ä–∞. –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è: "post_text: –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π Instagram caption —Å CTA –∏ —Ö—ç—à—Ç–µ–≥–∞–º–∏". –•–∞—Ä–¥–∫–æ–¥ –≤ fallback –ø—Ä–æ–º–ø—Ç–µ. **–ù–µ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ –∞–¥–º–∏–Ω–∫–µ** ‚Äî –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–ª–æ—Å—å –ø–æ–ª–µ `post_text_prompt` –≤ `ai_engine_config`.

### –ü–æ–¥–ø–∏—Å—å "NEIROCITI AI"

**–£–±—Ä–∞–Ω–∞.** –ë—ã–ª–∞ –≤ `sendToTelegram()` —Å—Ç—Ä–æ–∫–∞ ~628: `postText.substring(0, 900) + '\n\n---\nü§ñ NEIROCITI AI'`. –ó–∞–º–µ–Ω–µ–Ω–∞ –Ω–∞ `postText.substring(0, 1024)`.

---

## –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –í –ë–î

### –¢–∞–±–ª–∏—Ü–∞ `ai_engine_config`

| –ö–æ–ª–æ–Ω–∫–∞ | –û–ø–∏—Å–∞–Ω–∏–µ | –¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ |
|---------|----------|-----------------|
| `text_provider` | –ü—Ä–æ–≤–∞–π–¥–µ—Ä —Ç–µ–∫—Å—Ç–∞ | `gemini` |
| `text_model` | –ú–æ–¥–µ–ª—å —Ç–µ–∫—Å—Ç–∞ | `gemini-2.5-flash` |
| `text_api_key` | API –∫–ª—é—á (–∏–ª–∏ `via_service_account` –¥–ª—è Vertex) | ‚Äî |
| `text_fallback_provider` | Fallback –ø—Ä–æ–≤–∞–π–¥–µ—Ä —Ç–µ–∫—Å—Ç–∞ | `openrouter` (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω) |
| `text_fallback_key` | API –∫–ª—é—á fallback | OpenRouter key |
| `image_provider` | –ü—Ä–æ–≤–∞–π–¥–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π | `gemini` |
| `image_model` | –ú–æ–¥–µ–ª—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π | `gemini-3-pro-image-preview` |
| `image_api_key` | API –∫–ª—é—á (Google AI Studio) | ‚Äî |
| `telegram_bot_token` | –¢–æ–∫–µ–Ω –±–æ—Ç–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ | ‚Äî |
| `cloudinary_cloud` | Cloudinary cloud name | ‚Äî |
| `cloudinary_preset` | Upload preset | ‚Äî |
| `use_search_grounding` | Google Search grounding | `true/false` |
| `use_internal_engine` | –§–ª–∞–≥: engine vs n8n | `false` (—Å–µ–π—á–∞—Å –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –ø–æ isAdmin) |
| `global_system_prompt` | –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç –∫–æ–ø–∏—Ä–∞–π—Ç–µ—Ä–∞ | –¢–µ–∫—Å—Ç –ø—Ä–æ–º–ø—Ç–∞ |
| `max_retries` | –ú–∞–∫—Å. –ø–æ–ø—ã—Ç–æ–∫ | `3` |

### –ß—Ç–æ –ù–£–ñ–ù–û –¥–æ–±–∞–≤–∏—Ç—å –≤ `ai_engine_config` (–º–∏–≥—Ä–∞—Ü–∏—è):

- `text_fallback_model` ‚Äî –º–æ–¥–µ–ª—å –¥–ª—è fallback —Ç–µ–∫—Å—Ç–∞ (–Ω–∞–ø—Ä. `google/gemini-2.5-flash` –¥–ª—è OpenRouter)
- `image_fallback_provider` ‚Äî fallback –ø—Ä–æ–≤–∞–π–¥–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- `image_fallback_model` ‚Äî fallback –º–æ–¥–µ–ª—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- `image_fallback_api_key` ‚Äî API –∫–ª—é—á fallback –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- `text_extra_api_keys` JSONB ‚Äî –¥–æ–ø. –∫–ª—é—á–∏ –¥–ª—è —Ä–æ—Ç–∞—Ü–∏–∏
- `image_extra_api_keys` JSONB ‚Äî –¥–æ–ø. –∫–ª—é—á–∏ –¥–ª—è —Ä–æ—Ç–∞—Ü–∏–∏
- `force_text_fallback` BOOLEAN ‚Äî –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π fallback —Ç–µ–∫—Å—Ç–∞ (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
- `force_image_fallback` BOOLEAN ‚Äî –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π fallback –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- `post_text_prompt` TEXT ‚Äî –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è Instagram caption

---

## –ü–õ–ê–ù –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)

### P0 ‚Äî –ö—Ä–∏—Ç–∏—á–Ω–æ (–¥–µ–ª–∞—Ç—å –ø–µ—Ä–≤—ã–º)

1. **–¢–∞–π–º-–∞—É—Ç—ã –Ω–∞ –≤—Å–µ fetch-–≤—ã–∑–æ–≤—ã** ‚Äî `fetchWithTimeout()` —Å AbortController
   - –¢–µ–∫—Å—Ç: 60—Å, –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: 90—Å
   - –ü—Ä–∏ —Ç–∞–π–º-–∞—É—Ç–µ ‚Äî –æ—à–∏–±–∫–∞ + –ª–æ–≥ + —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

2. **–í–æ–∑–≤—Ä–∞—Ç –º–æ–Ω–µ—Ç –ø—Ä–∏ –æ—à–∏–±–∫–µ** ‚Äî –≤ `runPipeline() catch`:
   - –í—ã–∑—ã–≤–∞—Ç—å RPC refund –∏–ª–∏ `add_coins`
   - –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é: "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞, –º–æ–Ω–µ—Ç—ã –≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã"
   - –ù—É–∂–Ω–æ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å `coinsSpent` –≤ payload —Å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞

3. **–§–∏–∫—Å fallback –º–æ–¥–µ–ª–∏ —Ç–µ–∫—Å—Ç–∞** ‚Äî —Å—Ç—Ä–æ–∫–∞ 333: `config.text_model` ‚Üí `config.text_fallback_model || config.text_model`

### P1 ‚Äî –í–∞–∂–Ω–æ

4. **–ú–∏–≥—Ä–∞—Ü–∏—è –ë–î** ‚Äî –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–ª–æ–Ω–∫–∏ fallback (—Ñ–∞–π–ª `075_ai_engine_fallback.sql`)
5. **Fallback –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π** ‚Äî try/catch –≤ `generateImage()` —Å –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ–º –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞
6. **–ü—Ä–æ–≥—Ä–∞–º–º–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ CTA** ‚Äî –ø–æ—Å–ª–µ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON, –µ—Å–ª–∏ slide[7].headline –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–æ–¥–æ–≤–æ–µ —Å–ª–æ–≤–æ ‚Äî –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ
7. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å—à–∏—Ö –≥–µ–Ω–µ—Ä–∞—Ü–∏–π** ‚Äî –µ—Å–ª–∏ > 5 –º–∏–Ω –∏ —Å—Ç–∞—Ç—É—Å –Ω–µ `success`/`error` ‚Äî –ø–æ–º–µ—á–∞—Ç—å `timeout`

### P2 ‚Äî –£–ª—É—á—à–µ–Ω–∏—è

8. **–†–æ—Ç–∞—Ü–∏—è API –∫–ª—é—á–µ–π** ‚Äî –ø—Ä–∏ 429 –ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–π –∫–ª—é—á –∏–∑ `text_extra_api_keys`
9. **–†–µ–¥–∏–∑–∞–π–Ω –∞–¥–º–∏–Ω–∫–∏ AI Engine** ‚Äî mobile-first, collapsible —Å–µ–∫—Ü–∏–∏
10. **–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–π post_text_prompt** ‚Äî –∏–∑ –∞–¥–º–∏–Ω–∫–∏, –≤–º–µ—Å—Ç–æ —Ö–∞—Ä–¥–∫–æ–¥–∞

---

## –î–ï–ü–õ–û–ô

```bash
# Edge Function (carousel-engine)
supabase functions deploy carousel-engine --project-ref debcwvxlvozjlqkhnauy

# –§—Ä–æ–Ω—Ç–µ–Ω–¥ (Vercel, –∞–≤—Ç–æ-–¥–µ–ø–ª–æ–π –ø—Ä–∏ push –≤ main)
git checkout main && git merge develop && git push

# –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î
supabase db push
```

---

## –ú–ê–†–®–†–£–¢–ò–ó–ê–¶–ò–Ø (–∫—Ç–æ –∫—É–¥–∞ –∏–¥—ë—Ç)

**–°–µ–π—á–∞—Å:**
- –ê–¥–º–∏–Ω—ã (ADMIN_IDS –≤ `src/config/admins.ts`) ‚Üí `carousel-engine` Edge Function
- –û–±—ã—á–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ ‚Üí `n8n.iferma.pro/webhook/carousel-v2` (—Å—Ç–∞—Ä—ã–π flow)

**–ö–æ–¥ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏:**
- `src/pages/agents/carousel/content.tsx` ‚Äî —Å—Ç—Ä–æ–∫–∏ ~181-217
- `src/pages/agents/carousel/index.tsx` ‚Äî —Å—Ç—Ä–æ–∫–∏ ~611-643
- `src/pages/agents/carousel-ai/index.tsx` ‚Äî –≤—Å–µ–≥–¥–∞ carousel-engine (–æ—Ç–¥–µ–ª—å–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞)

**–ß—Ç–æ–±—ã –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –í–°–ï–• –Ω–∞ engine:**
–ó–∞–º–µ–Ω–∏—Ç—å `isAdmin(currentUserId)` –Ω–∞ `true` –≤ –æ–±–æ–∏—Ö —Ñ–∞–π–ª–∞—Ö. –ò–ª–∏ –≤–µ—Ä–Ω—É—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É `use_internal_engine` –∏–∑ –ë–î.
